name: Build_x86_64_OpenWrt

on:
  repository_dispatch:
  workflow_dispatch:
  push:
    branches:
      - master

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout main repository (AutoBuild-OpenWrt)
      uses: actions/checkout@v4

    - name: Initialization environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        echo "Starting environment initialization..."
        set -e
        docker rmi $(docker images -q) || true
        echo "Deleting pre-installed large files..."
        sudo rm -rf \
          /usr/share/dotnet \
          /usr/local/lib/android \
          /opt/ghc \
          /etc/mysql \
          /etc/php
        sudo -E apt-get -y purge azure-cli* docker* ghc* zulu* hhvm* llvm* firefox* google* dotnet* aspnetcore* powershell* openjdk* adoptopenjdk* mysql* php* mongodb* moby* snap* || true
        echo "Updating apt package list..."
        sudo -E apt-get update
        echo "Installing build dependencies..."
        sudo -E apt-get -y install ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential bzip2 ccache cmake cpio curl device-tree-compiler fastjar flex gawk gettext gcc-multilib g++-multilib git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libfuse-dev libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libpython3-dev libreadline-dev libssl-dev libtool lrzsz mkisofs msmtp ninja-build p7zip p7zip-full patch pkgconf python3 python3-pyelftools python3-setuptools qemu-utils rsync scons squashfs-tools subversion swig texinfo uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev
        echo "Cleaning up apt cache..."
        sudo -E apt-get -y autoremove --purge
        sudo -E apt-get clean
        echo "Environment initialization complete."

    - name: Clone OpenWrt source code
      env:
        REPO_URL: https://github.com/coolsnowwolf/lede
        REPO_BRANCH: master
      run: |
        echo "Cloning OpenWrt source from $REPO_URL branch $REPO_BRANCH..."
        git clone --depth 1 $REPO_URL -b $REPO_BRANCH openwrt
        echo "OpenWrt source cloned."

    - name: Manually add/override custom packages from OpenWrt-package repository
      run: |
        echo "Cloning mouse2980/OpenWrt-package repository to a temporary directory..."
        git clone --depth 1 https://github.com/mouse2980/OpenWrt-package.git temp_custom_package_files
        
        # --- 处理 geoview ---
        GEOVIEW_PKG_TARGET_DIR="openwrt/package/custom_packages/geoview"
        GEOVIEW_SOURCE_MK="temp_custom_package_files/geoview_override.mk"
        GEOVIEW_SOURCE_CONFIG_IN="temp_custom_package_files/geoview_override.Config.in"
        echo "Creating custom package directory for geoview: ${GEOVIEW_PKG_TARGET_DIR}"
        mkdir -p "${GEOVIEW_PKG_TARGET_DIR}"
        if [ -f "${GEOVIEW_SOURCE_MK}" ] && [ -f "${GEOVIEW_SOURCE_CONFIG_IN}" ]; then
          echo "Copying custom geoview Makefile and Config.in..."
          cp "${GEOVIEW_SOURCE_MK}" "${GEOVIEW_PKG_TARGET_DIR}/Makefile"
          cp "${GEOVIEW_SOURCE_CONFIG_IN}" "${GEOVIEW_PKG_TARGET_DIR}/Config.in"
          echo "Custom geoview Makefile and Config.in successfully copied."
        else
          echo "ERROR: Custom geoview override files (geoview_override.mk or geoview_override.Config.in) NOT found in the cloned temp_custom_package_files directory."
          echo "Please ensure these files exist in your https://github.com/mouse2980/OpenWrt-package.git repository."
          ls -la temp_custom_package_files/ # 列出临时目录内容以供调试
          exit 1
        fi

        # --- 处理 dns2socks-rust ---
        DNS2SOCKS_RUST_PKG_TARGET_DIR="openwrt/package/custom_packages/dns2socks-rust"
        DNS2SOCKS_RUST_SOURCE_MK="temp_custom_package_files/dns2socks-rust_override.mk"
        DNS2SOCKS_RUST_SOURCE_CONFIG_IN="temp_custom_package_files/dns2socks-rust_override.Config.in"
        echo "Creating custom package directory for dns2socks-rust: ${DNS2SOCKS_RUST_PKG_TARGET_DIR}"
        mkdir -p "${DNS2SOCKS_RUST_PKG_TARGET_DIR}"
        if [ -f "${DNS2SOCKS_RUST_SOURCE_MK}" ]; then
          echo "Copying custom dns2socks-rust Makefile..."
          cp "${DNS2SOCKS_RUST_SOURCE_MK}" "${DNS2SOCKS_RUST_PKG_TARGET_DIR}/Makefile"
          echo "Custom dns2socks-rust Makefile successfully copied."
        else
          echo "WARNING: Custom dns2socks-rust_override.mk NOT found in temp_custom_package_files. This package might not be available."
        fi
        if [ -f "${DNS2SOCKS_RUST_SOURCE_CONFIG_IN}" ]; then
          cp "${DNS2SOCKS_RUST_SOURCE_CONFIG_IN}" "${DNS2SOCKS_RUST_PKG_TARGET_DIR}/Config.in"
          echo "Custom dns2socks-rust Config.in successfully copied."
        else
          echo "INFO: Custom dns2socks-rust_override.Config.in NOT found. Default Kconfig registration will be used if Makefile is present."
        fi
        
        echo "Cleaning up temporary repository clone..."
        rm -rf temp_custom_package_files
        echo "Manual package addition step finished."

    - name: Configure and Update OpenWrt Feeds
      working-directory: ./openwrt
      run: |
        echo "Configuring feeds..."
        echo "src-git kenzo https://github.com/kenzok8/openwrt-packages" >> ./feeds.conf.default
        echo "src-git small https://github.com/kenzok8/small" >> ./feeds.conf.default
        
        echo "Updating feeds..."
        ./scripts/feeds update -a
        
        echo "Installing packages from custom feeds..."
        # 注意：如果 kenzo 和 small feeds 非常大，全局 install -a 可能会消耗大量磁盘空间
        # 并可能引入未预期的依赖问题。更优化的方式是只 install 你明确需要的包。
        # 例如: ./scripts/feeds install -p small luci-app-ssr-plus <其他包>
        # 如果遇到磁盘空间问题，这是首先需要优化的地方。
        ./scripts/feeds install -a 
        ./scripts/feeds install -a 
        echo "Feeds update and install step finished."

    - name: Configuration Customization - Build_x86_64
      env:
        CONFIG_FILE: 'x86_64.config' # 确保此文件位于 AutoBuild-OpenWrt 仓库根目录
      run: |
        echo "Starting configuration customization..."
        if [ -e ../$CONFIG_FILE ]; then
          echo "Moving $CONFIG_FILE to openwrt/.config"
          mv ../$CONFIG_FILE openwrt/.config
        else
          echo "ERROR: $CONFIG_FILE not found in repository root."
          exit 1
        fi
        
        # 确保 customize.sh 位于 AutoBuild-OpenWrt 仓库根目录
        if [ -f ../customize.sh ]; then
          echo "Running customize.sh script..."
          cp ../customize.sh openwrt/customize.sh
          chmod +x openwrt/customize.sh
          (cd openwrt && ./customize.sh)
        else
          echo "customize.sh not found, skipping."
        fi
        
        echo "Running make defconfig..."
        cd openwrt
        rm -rf tmp # 清理 tmp 目录，确保配置干净
        make defconfig
        echo "make defconfig finished. Check log for recursive dependency errors."
        
    - name: Download package sources
      working-directory: ./openwrt
      run: |
        echo "Downloading package sources..."
        make download -j$(nproc)
        echo "Cleaning up small/incomplete downloads..."
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;
        echo "Download step finished."

    - name: Build firmware
      working-directory: ./openwrt
      run: |
        echo "Starting firmware build with $(nproc) threads."
        make -j$(nproc) V=s
        echo "Firmware build finished."

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      if: success() || failure() # 无论成功失败都上传，方便排查
      with:
        name: OpenWrt_x86_64_firmware-${{ github.run_id }}-${{ github.run_attempt }}
        path: |
          openwrt/bin/targets/
          openwrt/.config
          openwrt/logs/ # 尝试上传 OpenWrt 编译日志 (如果存在)
        retention-days: 7
